name: Deploy to Fly.io
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          curl -L https://fly.io/install.sh | sh
          export PATH=$HOME/.fly/bin:$PATH
          curl https://rclone.org/install.sh | sudo bash
          sudo apt-get update && sudo apt-get install -y jq gh

      - name: Authenticate Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl auth login --access-token "${{ secrets.FLY_API_TOKEN }}"

      - name: Configure Rclone and Get Tokens
        run: |
          # Buat konfigurasi Rclone untuk Google Drive
          rclone config create gdrive drive scope drive config_is_local false
          
          # Simpan konfigurasi sementara
          RCLONE_CONFIG=$(rclone config dump)

          # Ambil Access Token & Refresh Token dari konfigurasi
          ACCESS_TOKEN=$(echo "$RCLONE_CONFIG" | jq -r '.gdrive.token.access_token')
          REFRESH_TOKEN=$(echo "$RCLONE_CONFIG" | jq -r '.gdrive.token.refresh_token')

          echo "Access Token: $ACCESS_TOKEN"
          echo "Refresh Token: $REFRESH_TOKEN"

          # Login ke GitHub CLI
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # Simpan token ke GitHub Secrets
          gh secret set RCLONE_ACCESS_TOKEN --body "$ACCESS_TOKEN"
          gh secret set RCLONE_REFRESH_TOKEN --body "$REFRESH_TOKEN"

      - name: Deploy to Fly.io
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_VOLUME_ID: ${{ secrets.FLY_VOLUME_ID }}
          RPC_SECRET: ${{ secrets.RPC_SECRET }}
          RCLONE_ACCESS_TOKEN: ${{ secrets.RCLONE_ACCESS_TOKEN }}
          RCLONE_REFRESH_TOKEN: ${{ secrets.RCLONE_REFRESH_TOKEN }}
        run: flyctl deploy --remote-only

      - name: Start Telegram Bot
        run: nohup python3 /app/bot/bot.py & 
        
      - name: Send Telegram Notification
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -d "text=âœ… Deployment berhasil! Aplikasi telah diperbarui dan berjalan di Fly.io ðŸš€"

      - name: Schedule Volume Check
        run: flyctl ssh console --command "bash /scripts/extend_volume.sh"
